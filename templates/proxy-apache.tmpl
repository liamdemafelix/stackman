# Virtual Host Configuration for %domain%
# Generated by Stackman
#
# Do not delete the lines below.
# These lines are used to identify settings for a virtual host.
# 
# User: %user%
# Mode: %mode%
# Proxy: %proxy%
# PHP Version: %php%

<VirtualHost *:80>
    ServerName %domain%
    %server_alias_line%
    ErrorLog /home/%user%/logs/%domain%_error.log
    CustomLog /home/%user%/logs/%domain%_access.log combined

    # Force HTTPS, except Let's Encrypt's .well-known/acme-challenge request
    Alias /.well-known/acme-challenge/ /home/%user%/acme-challenge/
    <Directory "/home/%user%/acme-challenge/">
        Options None
        AllowOverride None
        ForceType text/plain
        RedirectMatch 404 "^(?!/\.well-known/acme-challenge/[\w-]{43}$)"
    </Directory>
    <Directory "/home/%user%/www/public">
        RewriteEngine On
        RewriteCond %{HTTPS} off
        RewriteCond %{REQUEST_URI} !^\/\.well-known\/.*$
        RewriteRule (.*) https://%{HTTP_HOST}%{REQUEST_URI}
    </Directory>
</VirtualHost>

<VirtualHost *:443>
    ServerName %domain%
    %server_alias_line%
    DocumentRoot %document_root%
    ErrorLog /home/%user%/logs/%domain%_error.log
    CustomLog /home/%user%/logs/%domain%_access.log combined

    SSLEngine On
    SSLCertificateFile "%ssl_cert%"
    SSLCertificateKeyFile "%ssl_key%"

    ProxyPass /.well-known !

    Alias /.well-known/acme-challenge/ /home/%user%/acme-challenge/
    <Directory "/home/%user%/acme-challenge/">
        Options None
        AllowOverride None
        ForceType text/plain
        RedirectMatch 404 "^(?!/\.well-known/acme-challenge/[\w-]{43}$)"
    </Directory>

    ProxyPreserveHost On
    ProxyPass / %proxy%
    ProxyPassReverse / %proxy%
</VirtualHost>