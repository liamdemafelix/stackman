# Virtual Host Configuration for %domain%
# Generated by Stackman

<VirtualHost *:80>
    ServerName %domain%
    %server_alias_line%
    DocumentRoot %document_root%
    ErrorLog /home/%user%/logs/%domain%_error.log
    CustomLog /home/%user%/logs/%domain%_access.log combined

    SSLEngine On
    SSLCertificateFile "%ssl_cert%"
    SSLCertificateKeyFile "%ssl_key%"

    # Force HTTPS, except Let's Encrypt's .well-known/acme-challenge request
    Alias /.well-known/acme-challenge/ /home/%user%/acme-challenge/
    <Directory "/home/%user%/acme-challenge/">
        Options None
        AllowOverride None
        ForceType text/plain
        RedirectMatch 404 "^(?!/\.well-known/acme-challenge/[\w-]{43}$)"
    </Directory>
    #SSLProxyEngine On
    RewriteEngine On
    RewriteCond %{REQUEST_URI} !^/.well-known/acme-challenge [NC]
    RewriteCond %{HTTPS} off
    RewriteRule (.*) https://%{HTTP_HOST}%{REQUEST_URI}

    <FilesMatch "\.php$">
        SetHandler  "proxy:unix:%fpm_socket%|fcgi://localhost/"
    </FilesMatch>
</VirtualHost>